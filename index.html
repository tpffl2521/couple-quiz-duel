<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Couple Quiz Duel</title>
  <style>
    :root{--bg1:#ff9a9e;--bg2:#fad0c4;--bg3:#fbc2eb;--bg4:#a6c1ee;--card:#ffffff;--text:#1f2937;--muted:#6b7280;--accent:#ff6b6b;--accent-2:#7c3aed;--accent-3:#10b981;--accent-4:#f59e0b;--shadow:0 10px 30px rgba(0,0,0,.12);--radius:22px}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,Apple Color Emoji,Segoe UI Emoji;color:var(--text);background:linear-gradient(135deg,var(--bg1) 0%,var(--bg3) 45%,var(--bg4) 100%);background-attachment:fixed}
    .wrap{min-height:100%;display:grid;place-items:center;padding:20px}
    .card{width:100%;max-width:880px;background:linear-gradient(180deg,#fff,#fff8ff);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    header{padding:18px 20px;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,#ffe4e6,#e9d5ff,#dbeafe)}
    .brand{display:flex;align-items:center;gap:12px;font-weight:900;letter-spacing:.2px}
    .brand .logo{width:40px;height:40px;border-radius:50%;background:conic-gradient(from 0deg,var(--accent),var(--accent-2),var(--accent-3),var(--accent-4),var(--accent));box-shadow:0 6px 14px rgba(0,0,0,.15) inset}
    .brand small{display:block;font-weight:600;color:#6b21a8;margin-top:-4px}
    .content{padding:20px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:720px){.grid-2{grid-template-columns:1fr}}
    input[type=text],input[type=number],textarea,select{width:100%;border:2px solid #f1f5f9;background:#fff;border-radius:14px;padding:14px 16px;font-size:16px;outline:none;transition:border .15s ease,box-shadow .15s ease}
    input:focus,textarea:focus,select:focus{border-color:#c4b5fd;box-shadow:0 0 0 4px #ede9fe}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:0;cursor:pointer;user-select:none;font-weight:800;letter-spacing:.3px;border-radius:14px;padding:14px 18px;font-size:16px;background:linear-gradient(90deg,#fb7185,#a78bfa);color:#fff;box-shadow:var(--shadow);transition:transform .06s ease,filter .2s ease}
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn.secondary{background:linear-gradient(90deg,#34d399,#fbbf24);color:#0f172a}
    .btn.ghost{background:#fff;color:#475569;border:2px dashed #e5e7eb;box-shadow:none}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:#f1f5f9;color:#334155;font-weight:700}
    .pill{padding:10px 12px;border-radius:999px;background:#0ea5e9;color:#fff;font-weight:800}
    .k{display:flex;flex-wrap:wrap;gap:10px}
    .hidden{display:none!important}
    .center{text-align:center}
    .players{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media (max-width:720px){.players{grid-template-columns:1fr}}
    .player{background:#fff;border:2px solid #f3f4f6;padding:12px;border-radius:16px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .player.active{border-color:#a78bfa;box-shadow:0 0 0 3px #ede9fe}
    .player .name{font-weight:900;font-size:18px}
    .player .score{font-size:28px;font-weight:900}
    .question-box{margin-top:14px;background:linear-gradient(180deg,#fff,#fff 60%,#fff6);border:2px solid #f1f5f9;border-radius:18px;padding:16px}
    .qtext{font-size:20px;font-weight:900;line-height:1.3}
    .options{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    .opt{padding:14px;border-radius:14px;border:2px solid #f1f5f9;background:#fff;cursor:pointer;font-weight:800}
    .opt:hover{border-color:#e9d5ff}
    .opt.correct{border-color:#34d399;background:#ecfdf5}
    .opt.wrong{border-color:#fb7185;background:#fff1f2}
    .footer{margin-top:14px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between}
    .chip{font-weight:800;padding:10px 12px;border-radius:12px;background:#eef2ff;color:#3730a3}
    .divider{height:1px;background:#f1f5f9;margin:16px 0}
    .leaderboard{display:grid;gap:10px}
    .row{display:flex;align-items:center;justify-content:space-between;background:#fff;border:2px solid #f1f5f9;padding:12px;border-radius:12px}
    .row small{color:#64748b;font-weight:700}
    .toast{position:fixed;inset:auto 16px 16px 16px;display:none}
    .toast.show{display:block;animation:pop .2s ease}
    .toast>div{background:#111827;color:#fff;padding:12px 14px;border-radius:12px;box-shadow:var(--shadow)}
    @keyframes pop{from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}
    .ribbon{position:absolute;top:8px;right:-10px;transform:rotate(8deg);background:#22c55e;color:#fff;padding:6px 12px;border-radius:10px;font-weight:900;box-shadow:var(--shadow)}
    .timer{display:inline-flex;align-items:center;gap:8px;font-weight:900;padding:8px 12px;border-radius:12px;background:#ffe4e6;color:#9f1239}
    .timer.low{background:#fee2e2;color:#991b1b;animation:blink .8s steps(1,end) infinite}
    @keyframes blink{50%{opacity:.3}}
    .text-input{display:flex;gap:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <div>Couple Quiz Duel</div>
            <small>Colorful ‚Ä¢ Mobile‚Äëfriendly ‚Ä¢ Seru untuk berdua üíû</small>
          </div>
        </div>
        <div class="k">
          <button class="btn ghost" id="btn-how">Cara main</button>
          <button class="btn secondary" id="btn-manage">Kelola pertanyaan</button>
        </div>
      </header>

      <section id="prefill" class="content hidden">
        <h2 class="center" style="margin:6px 0 10px 0">Kunci Jawaban ‚Äî <span id="pfStepLabel">Player A</span></h2>
        <p class="center" style="margin:0 0 12px 0;color:#475569">Gantian isi. Layar untuk <b id="pfWho">Player A</b> saja.</p>
        <div>
          <div class="player">
            <div><div class="name" id="pfNameSolo">Player A</div><small class="muted">Sedang mengisi kunci</small></div>
            <div class="pill" id="pfBadge">A</div>
          </div>
          <div id="prefillSolo" style="margin-top:10px;display:grid;gap:10px"></div>
        </div>
        <div class="center" style="margin-top:14px" id="prefillActions">
          <button class="btn" id="saveAndPass">Simpan & Serahkan ke <span id="nextHolder">Player B</span></button>
          <button class="btn secondary hidden" id="startAfterPrefill">Mulai Duel</button>
          <button class="btn ghost" id="backToSetup">Kembali</button>
        </div>
        <div id="handoverCover" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:grid;place-items:center;">
          <div style="background:#fff;padding:18px;border-radius:16px;max-width:520px;text-align:center;box-shadow:var(--shadow)">
            <h3 id="handoverTitle" style="margin:0 0 6px 0">Giliran Player B</h3>
            <p id="handoverDesc" style="margin:0 0 12px 0;color:#475569">Tutup layar, serahkan perangkat.</p>
            <button class="btn" id="confirmHandover">Saya Player B, siap isi</button>
          </div>
        </div>
      </section>

      <section id="setup" class="content">
        <h2 class="center" style="margin:6px 0 14px 0">Masukkan nama pemain</h2>
        <div class="grid-2">
          <div>
            <label>Player A</label>
            <input id="p1" type="text" value="Kamu" />
          </div>
          <div>
            <label>Player B</label>
            <input id="p2" type="text" value="Dia" />
          </div>
        </div>
        <div class="grid-2" style="margin-top:10px">
          <div>
            <label>Jumlah ronde</label>
            <select id="rounds">
              <option value="5">5</option>
              <option value="8" selected>8</option>
              <option value="10">10</option>
              <option value="12">12</option>
              <option value="all">Semua pertanyaan</option>
            </select>
          </div>
          <div>
            <label>Mode giliran</label>
            <select id="turnMode">
              <option value="alternate" selected>Bergantian</option>
              <option value="steal">Bisa rebut</option>
            </select>
          </div>
        </div>
        <div class="grid-2" style="margin-top:10px">
          <div>
            <label>Timer per soal (detik)</label>
            <div class="text-input">
              <input id="timerSec" type="number" value="15" min="5" max="120" />
              <label style="display:flex;align-items:center;gap:6px"><input id="timerOn" type="checkbox" checked />Aktif</label>
            </div>
          </div>
          <div>
            <label>Case sensitive untuk jawaban teks</label>
            <select id="caseMode">
              <option value="insensitive" selected>Abaikan</option>
              <option value="sensitive">Perhatikan</option>
            </select>
          </div>
        </div>
        <div class="center" style="margin-top:16px">
          <button class="btn" id="start">Mulai Duel</button>
        </div>
        <div class="divider"></div>
        <div>
          <h3 style="margin:0 0 8px 0">Leaderboard Lucu</h3>
          <div id="board" class="leaderboard"></div>
        </div>
      </section>

      <section id="game" class="content hidden">
        <div class="players">
          <div id="paneA" class="player"><span class="name" id="nA">A</span><span class="score" id="sA">0</span></div>
          <div id="paneB" class="player"><span class="name" id="nB">B</span><span class="score" id="sB">0</span></div>
        </div>
        <div class="question-box">
          <div class="k" style="justify-content:space-between;align-items:center">
            <span class="badge" id="roundBadge">Ronde 1</span>
            <span class="chip" id="turnBadge">Giliran: <b id="turnName">-</b></span>
            <span class="timer hidden" id="timer">‚è± <b id="tsec">15</b>s</span>
          </div>
          <div class="qtext" id="qtext" style="margin-top:10px">‚Äî</div>
          <div class="options" id="options"></div>
        </div>
        <div class="footer">
          <div class="k">
            <button class="btn ghost" id="skip">Lewati</button>
            <button class="btn secondary" id="end">Akhiri & Lihat Hasil</button>
          </div>
          <div class="pill" id="leftCount">Sisa: 0</div>
        </div>
      </section>

      <section id="result" class="content hidden">
        <div style="position:relative">
          <div id="ribbon" class="ribbon hidden">Juara!</div>
          <h2 class="center" style="margin:4px 0 10px 0">Hasil Duel</h2>
        </div>
        <div class="players">
          <div class="player">
            <div>
              <div class="name" id="resA"></div>
              <small class="muted" id="titleA"></small>
            </div>
            <div class="score" id="scoreA"></div>
          </div>
          <div class="player">
            <div>
              <div class="name" id="resB"></div>
              <small class="muted" id="titleB"></small>
            </div>
            <div class="score" id="scoreB"></div>
          </div>
        </div>
        <div class="center" style="margin-top:14px" id="summary"></div>
        <div class="center" style="margin-top:14px">
          <button class="btn" id="again">Main lagi</button>
          <button class="btn secondary" id="home">Kembali ke menu</button>
        </div>
      </section>
    </div>
  </div>

  <dialog id="howModal" style="max-width:720px;border:0;border-radius:16px;box-shadow:var(--shadow)">
    <form method="dialog" style="padding:0">
      <header style="padding:14px 16px;background:#f0f9ff"><b>Bagaimana cara main?</b></header>
      <div style="padding:16px;">
        <ol>
          <li>Isi nama Player A dan Player B, pilih jumlah ronde.</li>
          <li>Pilih mode giliran bergantian atau rebut.</li>
          <li>Aktifkan timer jika mau lebih menantang.</li>
          <li>Pertanyaan bisa bertipe Multiple Choice, True/False, atau Jawaban Teks.</li>
        </ol>
      </div>
      <div style="padding:12px 16px;display:flex;justify-content:flex-end;gap:10px;background:#f8fafc">
        <button class="btn ghost">Tutup</button>
      </div>
    </form>
  </dialog>

  <dialog id="manageModal" style="max-width:920px;border:0;border-radius:16px;box-shadow:var(--shadow)">
    <form method="dialog" style="padding:0">
      <header style="padding:14px 16px;background:#fef3c7">
        <b>Kelola Pertanyaan</b>
        <small style="color:#92400e;font-weight:700">(simpan untuk menyimpan ke perangkat)</small>
      </header>
      <div style="padding:16px;">
        <details open>
          <summary style="cursor:pointer;font-weight:800;margin-bottom:10px">Format JSON</summary>
          <div style="margin-top:6px;color:#475569">
            <ul>
              <li>{"type":"mc","q":"teks","options":["A","B"],"answer":0}</li>
              <li>{"type":"tf","q":"teks","answer":true}</li>
              <li>{"type":"text","q":"teks","answers":["a","b"]}</li>
            </ul>
          </div>
        </details>
        <textarea id="jsonBox" rows="16" style="width:100%;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace"></textarea>
        <div class="k" style="margin-top:10px">
          <button class="btn" id="saveQuestions" type="button">Simpan</button>
          <button class="btn secondary" id="resetQuestions" type="button">Reset</button>
          <button class="btn ghost" id="exportBtn" type="button">Ekspor .json</button>
          <input id="importFile" type="file" accept="application/json" class="hidden" />
          <button class="btn ghost" id="importBtn" type="button">Impor .json</button>
          <button class="btn ghost" value="cancel">Tutup</button>
        </div>
      </div>
    </form>
  </dialog>

  <div class="toast" id="toast"><div id="toastMsg">Tersimpan!</div></div>

  <script>
    const $=q=>document.querySelector(q);const $$=q=>document.querySelectorAll(q);const vibrate=pat=>{if(navigator.vibrate)navigator.vibrate(pat)};const shuffle=arr=>arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(v=>v[1]);const show=id=>{['#setup','#game','#result','#prefill'].forEach(s=>$(s).classList.add('hidden'));$(id).classList.remove('hidden')};const toast=msg=>{const t=$('#toast');$('#toastMsg').textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1400)};
    const DEFAULT_QUESTIONS=[{type:"mc",q:"Apa makanan favoritku?",options:["Sushi","Bakso","Ayam Geprek","Mie Goreng"],answer:1},{type:"mc",q:"Tanggal kita pertama kali jalan bareng?",options:["14 Feb","1 Jan","7 Juli","24 Mei"],answer:0},{type:"mc",q:"Minuman yang paling sering aku pesan?",options:["Es Teh Manis","Kopi Susu","Jus Alpukat","Boba"],answer:1},{type:"tf",q:"Aku alergi udang.",answer:true},{type:"mc",q:"Aku paling suka liburan ke‚Ä¶",options:["Pantai","Gunung","Kota","Rumah aja"],answer:0},{type:"text",q:"Sebutkan warna favoritku.",answers:["hijau","ijo"]},{type:"mc",q:"Kalau quality time, aku lebih suka‚Ä¶",options:["Nonton","Jalan sore","Masak bareng","Main game"],answer:3},{type:"mc",q:"Hal kecil yang bikin aku senang?",options:["Chat pagi","Dibelikan snack","Dipijat","Surat lucu"],answer:0}];
    const STORAGE_KEY_Q='couple-quiz-questions-v2';const STORAGE_KEY_B='couple-quiz-board-v1';const STORAGE_KEY_K='couple-quiz-keys-v1';
    function loadQuestions(){try{const raw=localStorage.getItem(STORAGE_KEY_Q);if(!raw)return DEFAULT_QUESTIONS.slice();const parsed=JSON.parse(raw);if(!Array.isArray(parsed))throw 0;return parsed}catch(e){return DEFAULT_QUESTIONS.slice()}}
    function saveQuestions(arr){localStorage.setItem(STORAGE_KEY_Q,JSON.stringify(arr))}
    function loadBoard(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY_B))||[]}catch(e){return []}}
    function saveBoard(b){localStorage.setItem(STORAGE_KEY_B,JSON.stringify(b))}
    let timerId=null;let tLeft=0;function startTimer(sec){if(!$('#timerOn').checked){$('#timer').classList.add('hidden');return}clearInterval(timerId);tLeft=sec;$('#tsec').textContent=tLeft;$('#timer').classList.remove('hidden');$('#timer').classList.remove('low');timerId=setInterval(()=>{tLeft--;$('#tsec').textContent=tLeft;if(tLeft<=5)$('#timer').classList.add('low');if(tLeft<=0){clearInterval(timerId);timesUp()}},1000)}function stopTimer(){clearInterval(timerId);$('#timer').classList.add('hidden')}
    let QUESTIONS=loadQuestions();let game={p1:'Kamu',p2:'Dia',turn:1,a:0,b:0,i:0,order:[],turnMode:'alternate',asked:[],caseSensitive:false};
    function renderBoard(){const board=loadBoard();const el=$('#board');el.innerHTML='';if(!board.length){el.innerHTML='<div class="row"><b>Belum ada catatan. Main dulu yuk! üéâ</b></div>';return}board.slice(0,10).forEach((r,idx)=>{const row=document.createElement('div');row.className='row';const title=r.title||(r.winner+" ‚Äî Raja Ingatan");const names=`${r.p1} vs ${r.p2}`;row.innerHTML=`<div><b>${idx+1}. ${title}</b><br><small>${names} ‚Ä¢ ${r.score}</small></div><small>${new Date(r.ts).toLocaleString()}</small>`;el.appendChild(row)})}
    function openManage(){$('#jsonBox').value=JSON.stringify(QUESTIONS,null,2);$('#manageModal').showModal()}
    function startGame(){game.p1=$('#p1').value.trim()||'Player A';game.p2=$('#p2').value.trim()||'Player B';game.turnMode=$('#turnMode').value;game.caseSensitive=$('#caseMode').value==='sensitive';game.a=0;game.b=0;game.i=0;game.turn=1;game.asked=[];$('#nA').textContent=game.p1;$('#nB').textContent=game.p2;$('#sA').textContent='0';$('#sB').textContent='0';const pool=QUESTIONS.slice();const want=$('#rounds').value==='all'?pool.length:parseInt($('#rounds').value,10);game.order=shuffle([...Array(pool.length).keys()]).slice(0,want);$('#leftCount').textContent=`Sisa: ${want}`;$('#roundBadge').textContent=`Ronde 1`;$('#turnName').textContent=game.turn===1?game.p1:game.p2;show('#game');nextQuestion()}
    function renderOptions(q,qi){const ops=$('#options');ops.innerHTML='';if(q.type==='tf'){['Benar','Salah'].forEach((label,i)=>{const b=document.createElement('button');b.className='opt';b.type='button';b.textContent=label;b.addEventListener('click',()=>handleAnswer(isCorrectTF(qi,i===0)));ops.appendChild(b)})}else if(q.type==='text'){const wrap=document.createElement('div');wrap.className='text-input';const input=document.createElement('input');input.type='text';input.placeholder='Ketik jawaban...';input.autofocus=true;input.className='opt';const submit=document.createElement('button');submit.className='btn';submit.type='button';submit.textContent='Jawab';submit.addEventListener('click',()=>{const ans=input.value.trim();handleAnswer(isCorrectText(qi,ans))});input.addEventListener('keydown',e=>{if(e.key==='Enter')submit.click()});wrap.appendChild(input);wrap.appendChild(submit);ops.appendChild(wrap)}else{(q.options||[]).forEach((opt,oi)=>{const b=document.createElement('button');b.className='opt';b.type='button';b.textContent=opt;b.addEventListener('click',()=>handleAnswer(isCorrectMC(qi,oi)));ops.appendChild(b)})}}
    function nextQuestion(){stopTimer();if(game.i>=game.order.length){finishGame();return}const idx=game.order[game.i];const q=QUESTIONS[idx];$('#qtext').textContent=q.q;renderOptions(q,idx);markActive();$('#roundBadge').textContent=`Ronde ${game.i+1}`;$('#leftCount').textContent=`Sisa: ${game.order.length-game.i}`;if($('#timerOn').checked){startTimer(parseInt($('#timerSec').value,10)||15)}}
    function markActive(){$('#paneA').classList.toggle('active',game.turn===1);$('#paneB').classList.toggle('active',game.turn===2);$('#turnName').textContent=game.turn===1?game.p1:game.p2}
    function lockOptions(){$$('#options .opt,#options button').forEach(o=>o.disabled=true)}
    function highlightCorrect(q){const qi=game.order[game.i];const opts=$$('#options .opt');if(q.type==='mc'){const key=getCorrectFor(qi,currentTarget());const correctIdx=typeof key==='number'?key:q.answer;opts.forEach((o,i)=>{if(i===correctIdx)o.classList.add('correct');else o.classList.add('wrong')})}else if(q.type==='tf'){const key=getCorrectFor(qi,currentTarget());const trueIsCorrect=typeof key==='boolean'?key:!!q.answer;opts.forEach((o,i)=>{if((i===0)===trueIsCorrect)o.classList.add('correct');else o.classList.add('wrong')})}}
    function handleAnswer(correct){stopTimer();lockOptions();const q=QUESTIONS[game.order[game.i]];if(q.type!=='text')highlightCorrect(q);if(correct){vibrate([40]);if(game.turn===1){game.a++;$('#sA').textContent=game.a}else{game.b++;$('#sB').textContent=game.b}toast('Betul! +1 poin');setTimeout(()=>{game.i++;game.turn=game.turn===1?2:1;nextQuestion()},500)}else{vibrate([20,40,20]);if(game.turnMode==='steal'){toast('Salah! Lawan boleh rebut');game.turn=game.turn===1?2:1;markActive();setTimeout(()=>{$$('#options .opt,#options button').forEach(o=>o.disabled=false);if($('#timerOn').checked){startTimer(Math.ceil((parseInt($('#timerSec').value,10)||15)/2))}},350)}else{toast('Salah!');setTimeout(()=>{game.i++;game.turn=game.turn===1?2:1;nextQuestion()},650)}}}
    function timesUp(){toast('Waktu habis!');if(game.turnMode==='steal'){game.turn=game.turn===1?2:1;markActive();startTimer(Math.ceil((parseInt($('#timerSec').value,10)||15)/2))}else{game.i++;game.turn=game.turn===1?2:1;nextQuestion()}}
    function finishGame(){show('#result');stopTimer();$('#resA').textContent=game.p1;$('#resB').textContent=game.p2;$('#scoreA').textContent=game.a;$('#scoreB').textContent=game.b;let titleA='',titleB='';if(game.a===game.b){titleA=titleB='Duo Sinkron ‚Äî Kompak Banget!';$('#summary').innerHTML='Seri! Sama kuatnya.';$('#ribbon').classList.add('hidden')}else if(game.a>game.b){titleA='Raja Ingatan üëë';titleB='Si Lupa Manis ü´£';$('#summary').innerHTML=`${game.p1} menang!`;$('#ribbon').classList.remove('hidden')}else{titleA='Si Lupa Manis ü´£';titleB='Raja Ingatan üëë';$('#summary').innerHTML=`${game.p2} menang!`;$('#ribbon').classList.remove('hidden')}$('#titleA').textContent=titleA;$('#titleB').textContent=titleB;const record={ts:Date.now(),p1:game.p1,p2:game.p2,score:`${game.a} : ${game.b}`,winner:game.a===game.b?'Seri':(game.a>game.b?game.p1:game.p2),title:game.a===game.b?'Duel Seri ‚Äî Kompak!':'Raja Ingatan'};const board=loadBoard();board.unshift(record);saveBoard(board);renderBoard()}
    function exportJSON(){const blob=new Blob([JSON.stringify(QUESTIONS,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='couple-quiz-questions.json';a.click();URL.revokeObjectURL(a.href)}
    function importJSON(file){const reader=new FileReader();reader.onload=e=>{try{const val=JSON.parse(e.target.result);if(!Array.isArray(val))throw 0;val.forEach(v=>{if(!v.q||typeof v.q!=='string')throw 0});QUESTIONS=val;saveQuestions(val);$('#jsonBox').value=JSON.stringify(QUESTIONS,null,2);toast('Impor berhasil')}catch{toast('File tidak valid.')}};reader.readAsText(file)}
    function loadKeys(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY_K))||{p1:{},p2:{}}}catch{return{p1:{},p2:{}}}}
    function saveKeys(k){localStorage.setItem(STORAGE_KEY_K,JSON.stringify(k))}
    function editorFor(q,qi,role){const wrap=document.createElement('div');wrap.style.background='#fff';wrap.style.border='2px solid #f1f5f9';wrap.style.borderRadius='12px';wrap.style.padding='10px';const title=document.createElement('div');title.style.fontWeight='900';title.style.marginBottom='6px';title.textContent=`Q${qi+1}. ${q.q}`;wrap.appendChild(title);const holder=document.createElement('div');let input;if(q.type==='tf'){input=document.createElement('select');input.innerHTML='<option value="true">Benar</option><option value="false">Salah</option>'}else if(q.type==='text'){input=document.createElement('input');input.type='text';input.placeholder='contoh: hijau; ijo'}else{input=document.createElement('select');(q.options||[]).forEach((o,i)=>{const op=document.createElement('option');op.value=i;op.textContent=o;input.appendChild(op)})}input.dataset.qi=qi;input.dataset.role=role;input.style.width='100%';input.style.padding='10px';input.style.border='2px solid #eef2ff';input.style.borderRadius='10px';holder.appendChild(input);wrap.appendChild(holder);return{wrap,input}}
    function buildPrefill(role){const k=loadKeys();const box=$('#prefillSolo');box.innerHTML='';window.__prefillInputs={[role]:[]};QUESTIONS.forEach((q,qi)=>{const e=editorFor(q,qi,role);box.appendChild(e.wrap);__prefillInputs[role].push(e.input);if(k[role]&&k[role][qi]!==undefined){e.input.value=String(k[role][qi])}})}
    function collectPrefill(role){const prev=loadKeys();const k={p1:prev.p1||{},p2:prev.p2||{}};(__prefillInputs[role]||[]).forEach((inp,qi)=>{k[role][qi]=inp.tagName==='SELECT'?(inp.value==='true'?true:(inp.value==='false'?false:Number(inp.value))):inp.value});saveKeys(k)}
    let __prefillRole='p1';
    function setPrefillRole(role){__prefillRole=role;const isA=role==='p1';const name=isA?($('#p1').value.trim()||'Player A'):($('#p2').value.trim()||'Player B');const otherName=isA?($('#p2').value.trim()||'Player B'):($('#p1').value.trim()||'Player A');$('#pfStepLabel').textContent=isA?'Player A':'Player B';$('#pfWho').textContent=isA?'Player A':'Player B';$('#pfNameSolo').textContent=name;$('#pfBadge').textContent=isA?'A':'B';$('#nextHolder').textContent=otherName;$('#startAfterPrefill').classList.toggle('hidden',isA);$('#saveAndPass').classList.toggle('hidden',!isA)}
    function showHandover(nextRole){const isNextA=nextRole==='p1';$('#handoverTitle').textContent='Giliran '+(isNextA?'Player A':'Player B');$('#handoverDesc').innerHTML='Tutup layar dulu, lalu serahkan perangkat ke <b>'+(isNextA?'Player A':'Player B')+'</b>.';$('#handoverCover').classList.remove('hidden');$('#confirmHandover').onclick=()=>{$('#handoverCover').classList.add('hidden');setPrefillRole(nextRole);buildPrefill(nextRole)}}
    function getCorrectFor(qi,target){const k=loadKeys();return k[target]?k[target][qi]:undefined}
    function currentTarget(){return game.turn===1?'p2':'p1'}
    function splitAnswers(str){return String(str||'').split(/[;,|]/).map(s=>s.trim()).filter(Boolean)}
    function isCorrectMC(qi,chosen){const key=getCorrectFor(qi,currentTarget());if(typeof key==='number')return chosen===key;const q=QUESTIONS[qi];return chosen===q.answer}
    function isCorrectTF(qi,guessTrue){const key=getCorrectFor(qi,currentTarget());if(typeof key==='boolean')return guessTrue===key;const q=QUESTIONS[qi];return guessTrue===!!q.answer}
    function isCorrectText(qi,typed){const key=getCorrectFor(qi,currentTarget());const list=key!==undefined?splitAnswers(key):(QUESTIONS[qi].answers||[]);if(!list||!list.length)return false;if(!game.caseSensitive){return list.some(a=>typed.toLowerCase()===String(a).toLowerCase())}return list.some(a=>typed===String(a))}
    $('#btn-how').addEventListener('click',()=>$('#howModal').showModal());
    $('#btn-manage').addEventListener('click',openManage);
    $('#start').addEventListener('click',()=>{setPrefillRole('p1');buildPrefill('p1');show('#prefill')});
    $('#skip').addEventListener('click',()=>{toast('Lewati');game.i++;game.turn=game.turn===1?2:1;nextQuestion()});
    $('#end').addEventListener('click',finishGame);
    $('#again').addEventListener('click',()=>{show('#game');game.a=0;game.b=0;$('#sA').textContent=0;$('#sB').textContent=0;game.i=0;nextQuestion()});
    $('#home').addEventListener('click',()=>{show('#setup')});
    $('#savePrefill');
    $('#saveAndPass').addEventListener('click',()=>{collectPrefill(__prefillRole);showHandover(__prefillRole==='p1'?'p2':'p1')});
    $('#startAfterPrefill').addEventListener('click',()=>{collectPrefill('p2');startGame()});
    $('#backToSetup').addEventListener('click',()=>{show('#setup')});
    $('#saveQuestions').addEventListener('click',()=>{try{const val=JSON.parse($('#jsonBox').value);if(!Array.isArray(val))throw 0;val.forEach(v=>{if(!v.q||(v.type==='mc'&&(!Array.isArray(v.options)||typeof v.answer!=='number'))){}});QUESTIONS=val;saveQuestions(val);toast('Pertanyaan disimpan')}catch(e){toast('Format tidak valid. Periksa lagi.')}});
    $('#resetQuestions').addEventListener('click',()=>{QUESTIONS=DEFAULT_QUESTIONS.slice();$('#jsonBox').value=JSON.stringify(QUESTIONS,null,2);saveQuestions(QUESTIONS);toast('Sudah kembali ke daftar bawaan')});
    $('#exportBtn').addEventListener('click',exportJSON);
    $('#importBtn').addEventListener('click',()=>$('#importFile').click());
    $('#importFile').addEventListener('change',e=>{if(e.target.files&&e.target.files[0])importJSON(e.target.files[0])});
    (function(){try{const prevQ=QUESTIONS.slice();const prevCase=game.caseSensitive;const prevTurn=game.turn;const prevKeys=localStorage.getItem(STORAGE_KEY_K);const TQ=[{type:'mc',q:'TEST MC',options:['A','B','C'],answer:1},{type:'tf',q:'TEST TF',answer:false},{type:'text',q:'TEST TEXT',answers:['alpha','beta']}];QUESTIONS=TQ;game.turn=1;game.caseSensitive=false;const keys={p1:{},p2:{}};keys.p2[0]=2;keys.p2[1]=true;keys.p2[2]='Beta;  ALPHA ';localStorage.setItem(STORAGE_KEY_K,JSON.stringify(keys));const results=[];results.push(['MC true',isCorrectMC(0,2)===true]);results.push(['MC false',isCorrectMC(0,1)===false]);results.push(['TF true',isCorrectTF(1,true)===true]);results.push(['TF false',isCorrectTF(1,false)===false]);results.push(['TEXT insensitive true',(game.caseSensitive=false,isCorrectText(2,'alpha')===true)]);results.push(['TEXT insensitive true (caps)',(game.caseSensitive=false,isCorrectText(2,'BETA')===true)]);results.push(['TEXT sensitive false (caps)',(game.caseSensitive=true,isCorrectText(2,'BETA')===false)]);console.table(results.map(([name,ok])=>({test:name,pass:ok})));QUESTIONS=prevQ;game.caseSensitive=prevCase;game.turn=prevTurn;if(prevKeys===null)localStorage.removeItem(STORAGE_KEY_K);else localStorage.setItem(STORAGE_KEY_K,prevKeys)}catch(e){}}
    )();
    renderBoard();
  </script>
</body>
</html>
